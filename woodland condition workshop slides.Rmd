---
title: "Condition workshop slides"
author: "Ewan McHenry"
date: "2023-03-11"
output: powerpoint_presentation
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)




# Ewan McHenry
##------ Fri Mar 10 12:03:15 2023 ------##
# make figures etc explaining the process for getting from measurements of woodland condition indicies to overall condition score
# se


# LIBRARIES ---------------------------------------------------------------
library(tidyverse)
library(htmltools) # for html text rendering in ggplot aes()
library(ggpubr)
library(RColorBrewer)
library(scales)

# CONDITION INDICY VALUES ---------------------------------------------

# generate data ---- 
set.seed(54-46)
con.vals.df = data.frame(ind = factor(c("Tree age distribution",
                                        "Herbivore impact",
                                        "Invasive plants (% cover)",
                                        "Number of native tree species", 
                                        "Native trees in canopy (%)",
                                        "Open space within woodland", 
                                        "Native regeneration",
                                        "Tree health",
                                        "Veteran trees",
                                        "Deadwood"))
)
con.vals.df$ind = factor(con.vals.df$ind, levels = unique(con.vals.df$ind))

con.vals.df$weight = runif(length(con.vals.df$ind), 0,1) %>% round(0)
con.vals.df$weight = c(1,1,1,2,1.5,0.7,1,1,2,3)
con.vals.df$weight = rep(1, length(con.vals.df$weight))


max.score <- 100
con.vals.df$score = runif(length(con.vals.df$ind), 0,max.score) %>% round(0)
con.vals.df$value = con.vals.df$score * con.vals.df$weight

con.vals.df$total = "Site Condition Score" # helper for stack

# function - plot sep + stack indicator values - p.indicator.sep_stack ----
  gg.bar.sep_stack <- function(
    df = con.vals.df,
    scale.sum = F, 
    stack.alpha = 0, 
    sep.alpha = 1 , 
    big.y_lim = T, 
    inds.to.drop = NA,
    just.total = F){
    
    df = con.vals.df
    scale.sum = F 
    stack.alpha = 1
    sep.alpha = 1  
    big.y_lim = T 
    inds.to.drop = NA
    just.total = F
    
    
    # set y axis limits
    tot.val = sum(df$value)
        y_lim = c(0, max(df$value))
    if(big.y_lim){
      y_lim[2] = tot.val
    }
    
    # drop indicies - inds.to.drop    
    df <- df[!(1:dim(df)[1]) %in% inds.to.drop,]
    
    # make df2 that includes a stack
    df2 <-  df
    df2$total  <-  df$ind
    df2  <-  rbind(df2,df)
    df2$total<- factor(df2$total, levels = unique(df2$total))
    
    # scale the stackto be out of 100
    df2$plot.val <- df2$value # new value to plot
    if(scale.sum){ # scale the stack if selected
      df2$plot.val[df2$total == df$total[1]] <-  100 * df2$plot.val[df2$total == df$total[1]]/
        sum(df$weight * max.score )
    }
    
    df2$alpha.val <-  sep.alpha
    df2$alpha.val[df2$total == df$total[1]] <- stack.alpha
    
        # plot options ---- 
colorCount = length(unique(con.vals.df$ind))
getPalette = colorRampPalette(brewer.pal(colorCount, "Paired"))
type.names = unique(con.vals.df$ind)
text.fact = 1

# plot ----
ggplot(df2, aes(fill = ind, x = total, y = plot.val, 
                             text = map(paste0("<b>", ind, "</b>", "<br>", " Value =", plot.val, " %"), HTML),
                             alpha = alpha.val),) +
      geom_bar( stat="identity", )+
      #ggtitle()+
      theme_pubr()+
      scale_x_discrete(name = NULL)+
      scale_y_continuous(name = "Condition value at site", limits = y_lim, breaks = pretty_breaks(5))+
      scale_alpha(limits = c(0, 1), guide='none')+
      labs(fill = "Indicator")+
      scale_fill_manual(values=rev(getPalette(colorCount)),
                        labels=(type.names))+
      theme(text = element_text(family = "sans"),
            legend.position = "none",
            plot.title = element_text(size = 14  *text.fact, face = "bold"),
            plot.subtitle = element_text(size = 8 *text.fact),
            legend.text =  element_text(size = 11 *text.fact),
            legend.title = element_blank(),
            axis.text.y = element_text(size = 11 *text.fact),
            axis.text.x = element_text(size = 11 *text.fact, angle = 310, hjust = 0),
            axis.title.y =  element_text(size = 12 *text.fact),
            axis.title.x =  element_blank(),
            plot.margin =  margin(0, 2, 0, 0, "cm")
      )
    
    }
    
    
  
```

### Example: Value of each indicators for site condition

```{r sep indicators, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 0, sep.alpha = 1, 
                big.y_lim = F )
```

### Combining the value of indicators

```{r sep indicators big lim, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 0, sep.alpha = 1, 
                big.y_lim = T )
```

### Combining the value of indicators: Site condition score

```{r indicators combined 03, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = T )
```

### What if we use less indicators?

```{r unscaled , echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = T )
```


### What if we use less indicators? - Condition drops!

```{r unscaled minus 1, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = T ,
                nrow.drop = 1 )
```



### What if we use less indicators? - Condition drops!

```{r  unscaled minus 2, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = T ,
                nrow.drop = 2 )
```



### What if we use less indicators? - Condition drops!

```{r  unscaled minus 3, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = F, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = T ,
                nrow.drop = 3 )
```


### Scaling solves this:
```{r scaled , echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F ,
                nrow.drop = 0 )
```

Condition score always out of 100  

Scoring is consistent even if:  

- We decide we need more/less indicators in the future
- Certain woodland types use more/less indicators  

### Scaling to a score out of 100 solves this:
```{r scaled minus 0, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F,
                nrow.drop = 0 )
```

### Scaling to a score out of 100 solves this:
```{r scaled minus 1, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F,
                nrow.drop = 1 )
```


### Scaling to a score out of 100 solves this:
```{r scaled minus 2, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F ,
                nrow.drop = 2 )
```


### Scaling to a score out of 100 solves this:
```{r scaled minus 3, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df,
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F ,
                nrow.drop = 3 )
```

### Scaled condition rating thresholds
```{r scaled total, echo = F,  out.width="100%"}
  gg.bar.sep_stack(df = con.vals.df[],
                scale.sum = T, 
                stack.alpha = 1, sep.alpha = 1, 
                big.y_lim = F ,
                nrow.drop = 0 )
```

### Delphi Example

```{r delphi example , echo = F,  out.width="100%"}

pop.true <-  2061
n.experts <- 5
guess.sd <- 1500.000000

rounds = 4
df <- data.frame(round =  rep(1:rounds, each = n.experts))
df$sd <- guess.sd/(df$round)
df$guess <- rnorm(length(df$sd), pop.true, guess.sd)

round.df <- df %>% group_by(round) %>% summarise(mean.guess = mean(guess))

ggplot()+
  geom_point(data = df, aes(y = guess, x = round), shape = 1, alpha = 0.4) +
  geom_point(data = round.df, aes(y = mean.guess, x = round), shape = 16, colour = "red") +
  scale_y_continuous(name = "Guess", #limits = c(0,pop.true*2), 
                     breaks = pretty_breaks(5))+
  theme_pubr()






```



